import streamlit as st
import pandas as pd
import utils

def show():
    # Container ch√≠nh
    st.markdown("<h2>Qu·∫£n l√Ω giao d·ªãch</h2>", unsafe_allow_html=True)
    
    # Layout: 2 c·ªôt (t·ªâ l·ªá 2:1)
    col_left, col_right = st.columns([2, 1])
    
    # C·ªôt tr√°i: Danh s√°ch giao d·ªãch v·ªõi b·ªô l·ªçc
    with col_left:
        st.markdown("<h3>L·ªãch s·ª≠ giao d·ªãch</h3>", unsafe_allow_html=True)
        
        # B·ªô l·ªçc
        filter_cols = st.columns([2, 1])
        with filter_cols[0]:
            search = st.text_input("T√¨m ki·∫øm giao d·ªãch", placeholder="Nh·∫≠p t·ª´ kh√≥a...")
        with filter_cols[1]:
            transaction_type_filter = st.selectbox(
                "Lo·∫°i giao d·ªãch",
                options=["all", "income", "expense"],
                format_func=lambda x: "T·∫•t c·∫£" if x == "all" else ("Thu" if x == "income" else "Chi")
            )
        
        # L·ªçc danh s√°ch giao d·ªãch
        filtered_transactions = st.session_state.transactions
        
        # L·ªçc theo lo·∫°i giao d·ªãch
        if transaction_type_filter != "all":
            filtered_transactions = [t for t in filtered_transactions if t['type'] == transaction_type_filter]
        
        # L·ªçc theo t·ª´ kh√≥a
        if search:
            filtered_transactions = [
                t for t in filtered_transactions 
                if search.lower() in t['description'].lower() or search.lower() in t['category'].lower()
            ]
        
        # T·∫°o dataframe
        df = utils.get_transaction_df(filtered_transactions)
        
        # Hi·ªÉn th·ªã danh s√°ch giao d·ªãch
        if not df.empty:
            st.markdown("<div style='max-height: 600px; overflow-y: auto;'>", unsafe_allow_html=True)
            
            for _, row in df.iterrows():
                cols = st.columns([3, 2, 2, 2, 1])
                
                # Format row
                icon = "‚¨áÔ∏è" if row['type'] == 'income' else "‚¨ÜÔ∏è"
                color = "green" if row['type'] == 'income' else "red"
                
                cols[0].markdown(f"<div style='display: flex; align-items: center;'><span>{icon}</span><span style='margin-left: 5px;'>{row['description']}</span></div>", unsafe_allow_html=True)
                cols[1].markdown(f"{row['category']}")
                cols[2].markdown(f"{row['date']}")
                cols[3].markdown(f"<span style='color: {color};'>{row['amount_display']}</span>", unsafe_allow_html=True)
                
                # N√∫t x√≥a
                if cols[4].button("üóëÔ∏è", key=f"delete_{row['id']}"):
                    # X√°c nh·∫≠n x√≥a
                    delete_confirm = st.warning(f"B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch '{row['description']}'?")
                    col1, col2 = st.columns(2)
                    
                    if col1.button("X√°c nh·∫≠n", key=f"confirm_{row['id']}"):
                        utils.delete_transaction(row['id'])
                        st.success("ƒê√£ x√≥a giao d·ªãch!")
                        st.rerun() # Changed here
                    
                    if col2.button("H·ªßy", key=f"cancel_{row['id']}"):
                        st.rerun() # Changed here
                
                # ƒê∆∞·ªùng ph√¢n c√°ch
                st.markdown("<hr style='margin: 5px 0; opacity: 0.3;'>", unsafe_allow_html=True)
            
            st.markdown("</div>", unsafe_allow_html=True)
        else:
            st.info("Kh√¥ng c√≥ giao d·ªãch n√†o")
    
    # C·ªôt ph·∫£i: Form th√™m giao d·ªãch
    with col_right:
        st.markdown("<h3>Th√™m giao d·ªãch m·ªõi</h3>", unsafe_allow_html=True)
        st.markdown("<div style='background-color: #f8f9fa; padding: 20px; border-radius: 10px;'>", unsafe_allow_html=True)
        
        with st.form(key="add_transaction_form_page"):
            # Lo·∫°i giao d·ªãch
            transaction_type = st.radio(
                "Lo·∫°i giao d·ªãch",
                options=["income", "expense"],
                format_func=lambda x: "Thu" if x == "income" else "Chi",
                horizontal=True
            )
            
            # S·ªë ti·ªÅn
            amount = st.number_input(
                "S·ªë ti·ªÅn (VNƒê)",
                min_value=1000.0,
                step=10000.0,
                format="%g"
            )
            
            # M√¥ t·∫£
            description = st.text_input("M√¥ t·∫£")
            
            # Danh m·ª•c
            category = st.selectbox(
                "Danh m·ª•c",
                options=utils.CATEGORIES[transaction_type]
            )
            
            # Ng√†y th√°ng
            date = st.date_input("Ng√†y")
            
            # N√∫t th√™m
            button_label = "Th√™m kho·∫£n thu" if transaction_type == "income" else "Th√™m kho·∫£n chi"
            
            submitted = st.form_submit_button(
                button_label,
                use_container_width=True,
                type="primary"
            )
            
            if submitted:
                # Validate
                if not description or amount <= 0:
                    st.error("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin v√† s·ªë ti·ªÅn h·ª£p l·ªá")
                else:
                    # Th√™m giao d·ªãch
                    transaction_data = {
                        'type': transaction_type,
                        'amount': amount,
                        'description': description,
                        'category': category,
                        'date': date.strftime("%Y-%m-%d")
                    }
                    
                    utils.add_transaction(transaction_data)
                    st.success("ƒê√£ th√™m giao d·ªãch th√†nh c√¥ng!")
                    st.rerun() # Changed here
        
        st.markdown("</div>", unsafe_allow_html=True)